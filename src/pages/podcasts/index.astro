---
import BaseLayout from "../../layouts/BaseLayout.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import configData from "../../../data/config.json";

// Get all podcasts and sort by date (latest first)
// Parse date strings to Date objects for sorting
const parseDate = (dateString: string): Date => {
    // Handle formats like "April 26, 2023"
    const months: { [key: string]: number } = {
        January: 0,
        February: 1,
        March: 2,
        April: 3,
        May: 4,
        June: 5,
        July: 6,
        August: 7,
        September: 8,
        October: 9,
        November: 10,
        December: 11,
    };

    const parts = dateString.split(" ");
    if (parts.length === 3) {
        const month = months[parts[0]];
        const day = parseInt(parts[1].replace(",", ""));
        const year = parseInt(parts[2]);
        return new Date(year, month, day);
    }
    return new Date(dateString);
};

// Helper function to summarize description to 2-3 lines (approximately 150-200 characters)
const summarizeDescription = (description: string): string => {
    if (!description) return "";

    // Remove URLs and clean up the text
    let cleaned = description
        .replace(/https?:\/\/[^\s]+/g, "") // Remove URLs
        .replace(/\n+/g, " ") // Replace newlines with spaces
        .trim();

    // If it's already short enough, return as is
    if (cleaned.length <= 180) {
        return cleaned;
    }

    // Find a good breaking point (sentence end or word boundary)
    const maxLength = 180;
    let truncated = cleaned.substring(0, maxLength);

    // Try to break at a sentence end
    const lastPeriod = truncated.lastIndexOf(".");
    const lastExclamation = truncated.lastIndexOf("!");
    const lastQuestion = truncated.lastIndexOf("?");
    const lastSentenceEnd = Math.max(lastPeriod, lastExclamation, lastQuestion);

    if (lastSentenceEnd > maxLength * 0.6) {
        // If we found a sentence end in the last 40% of the text, use it
        truncated = truncated.substring(0, lastSentenceEnd + 1);
    } else {
        // Otherwise, break at a word boundary
        const lastSpace = truncated.lastIndexOf(" ");
        if (lastSpace > maxLength * 0.7) {
            truncated = truncated.substring(0, lastSpace) + "...";
        } else {
            truncated = truncated.substring(0, maxLength) + "...";
        }
    }

    return truncated.trim();
};

const podcasts = [...configData.podcasts]
    .map((podcast) => ({
        ...podcast,
        publishedDate: parseDate(podcast.date),
        summary: summarizeDescription(podcast.description || ""),
    }))
    .sort((a, b) => b.publishedDate.getTime() - a.publishedDate.getTime());
---

<BaseLayout
    title="Podcasts | 42 Interactive"
    description="Watch our latest podcasts and videos about technology, design, and innovation"
    bodyClass="podcasts-listing-page"
>
    <Header activePage="who-we-are" />

    <main class="main-content">
        <!-- ========================================
             HERO
             ======================================== -->
        <section class="podcasts-hero section-hero fade-in" data-theme="dark">
            <div class="hero-bg-image-wrapper">
                <img
                    src="/images/podcast/image.png"
                    alt=""
                    class="hero-bg-image"
                />
            </div>
            <div class="hero-info">
                <div class="hero-text-box">
                    <h1 class="hero-title">Our Story</h1>
                </div>
                <div class="hero-credits-box">
                    <p class="credit-value">
                        Here's a glimpse into our world, what we do and what
                        makes us different.
                    </p>
                </div>
            </div>
        </section>

        <section class="podcasts-listing-section" data-theme="light">
            <div class="section-inner">
                <div class="podcasts-grid grid-3col">
                    {
                        podcasts.map((podcast) => (
                            <div
                                class="podcast-card youtube-video-card"
                                data-video-id={podcast.id}
                            >
                                <div class="podcast-card-image-wrapper">
                                    <img
                                        src={`https://img.youtube.com/vi/${podcast.id}/maxresdefault.jpg`}
                                        alt={podcast.title}
                                        class="podcast-image"
                                    />
                                    <div class="podcast-card-overlay">
                                        <div class="play-button">
                                            <svg
                                                width="68"
                                                height="48"
                                                viewBox="0 0 68 48"
                                                fill="none"
                                            >
                                                <path
                                                    d="M66.52,7.74c-0.78-2.93-2.49-5.41-5.42-6.19C55.79,.13,34,0,34,0S12.21,.13,6.9,1.55 C3.97,2.33,2.27,4.81,1.48,7.74C0.06,13.05,0,24,0,24s0.06,10.95,1.48,16.26c0.78,2.93,2.49,5.41,5.42,6.19 C12.21,47.87,34,48,34,48s21.79-0.13,27.1-1.55c2.93-0.78,4.64-3.26,5.42-6.19C67.94,34.95,68,24,68,24S67.94,13.05,66.52,7.74z"
                                                    fill="#f00"
                                                />
                                                <path
                                                    d="M 45,24 27,14 27,34"
                                                    fill="#fff"
                                                />
                                            </svg>
                                        </div>
                                    </div>
                                </div>
                                <div class="podcast-card-content">
                                    <h3 class="podcast-title">
                                        {podcast.title}
                                    </h3>
                                    {podcast.summary && (
                                        <p class="podcast-abstract">
                                            {podcast.summary}
                                        </p>
                                    )}
                                    <p class="podcast-date">{podcast.date}</p>
                                </div>
                            </div>
                        ))
                    }
                </div>
            </div>
        </section>
    </main>

    <Footer />
</BaseLayout>

<style>
    .podcasts-hero {
        position: relative;
    }

    .podcasts-hero .hero-info {
        left: 50%;
        transform: translateX(-50%);
        align-items: flex-end;
    }

    .podcasts-hero .hero-text-box {
        background-color: rgba(42, 42, 252, 0.8);
        padding: 25px 60px;
        width: 620px;
        height: 266px;
        display: flex;
        align-items: center;
        box-sizing: border-box;
    }

    .podcasts-hero .hero-title {
        font-family: "Montserrat", sans-serif;
        font-weight: 800;
        font-size: 60px;
        line-height: 1;
        color: #ffffff;
        margin: 0;
        text-align: left;
    }

    .podcasts-hero .hero-credits-box {
        background-color: rgba(16, 22, 83, 0.8);
        width: 720px;
        height: 133px;
        padding: 20px 40px;
        display: flex;
        justify-content: center;
        align-items: center;
        box-sizing: border-box;
    }

    .podcasts-hero .hero-credits-box .credit-value {
        font-family: "Inter", sans-serif;
        font-weight: 300;
        font-size: 16px;
        line-height: 22.4px;
        color: #ffffff;
        margin: 0;
        text-align: left;
    }

    .podcasts-listing-section {
        background-color: #ffffff;
        padding: 80px 0;
        min-height: 60vh;
    }

    .podcasts-grid {
        margin-top: 40px;
        align-items: stretch; /* Ensure all cards have same height */
    }

    .podcast-card {
        display: flex;
        flex-direction: column;
        background: transparent;
        border-radius: 8px;
        overflow: hidden;
        cursor: pointer;
        height: 100%; /* Ensure cards fill grid cell */
    }

    .podcast-card:hover {
        /* No card movement - only image zooms */
    }

    .podcast-card-image-wrapper {
        position: relative;
        width: 100%;
        height: 280px; /* Fixed height for consistency */
        overflow: hidden;
        background: var(--bg-gray);
        margin-bottom: 20px;
    }

    .podcast-image {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s ease;
    }

    .podcast-card:hover .podcast-image {
        transform: scale(1.15);
    }

    .podcast-card-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.4);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .podcast-card:hover .podcast-card-overlay {
        opacity: 1;
    }

    .play-button {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .play-button svg {
        width: 68px;
        height: 48px;
        transition: transform 0.3s ease;
    }

    .podcast-card:hover .play-button svg {
        transform: scale(1.1);
    }

    .podcast-card-content {
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    .podcast-title {
        font-size: 1.3rem;
        font-weight: 600;
        margin-bottom: 12px;
        color: var(--text-dark, #0e1026);
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 4; /* Allow up to 4 lines for longer titles */
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .podcast-description {
        display: none; /* Hidden by default */
    }

    .podcast-abstract {
        font-size: 0.95rem;
        color: #666666;
        margin-bottom: 12px;
        line-height: 1.6;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .podcast-date {
        font-size: 0.85rem;
        color: #999999;
        margin-top: auto;
    }

    /* Responsive */
    @media (max-width: 1024px) {
        .podcasts-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .podcast-card-image-wrapper {
            height: 240px; /* Slightly smaller on tablet */
        }
    }

    @media (max-width: 768px) {
        .podcasts-listing-section {
            padding: 60px 0;
        }

        .podcasts-grid {
            grid-template-columns: 1fr;
        }

        .podcast-card-image-wrapper {
            height: 200px; /* Smaller on mobile */
        }
    }
</style>

<script>
    // Initialize YouTube lightbox functionality for podcast cards
    // The existing youtube.js will handle .youtube-video-card elements
    document.addEventListener("DOMContentLoaded", function () {
        if ((window as any).App && (window as any).App.initYouTubeLightbox) {
            (window as any).App.initYouTubeLightbox();
        }
    });
</script>
